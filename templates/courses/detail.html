{% extends "base.html" %}
{% block content %}

<section style="
    display:grid;
    grid-template-columns:2.5fr 1fr;
    gap:40px;
">

<!-- ================= LEFT SIDE ================= -->
<div>

    <!-- COURSE INFO -->
    <section style="
        background:#fff;
        padding:45px;
        border-radius:20px;
        box-shadow:0 12px 32px rgba(0,0,0,0.08);
        margin-bottom:45px;
    ">
        <h1 style="color:#7b2c2c; margin-top:0;">
            {{ course.title }}
        </h1>

        <p style="font-size:17px; line-height:1.8; color:#555;">
            {{ course.description }}
        </p>

        <div style="
            margin-top:20px;
            font-size:14px;
            color:#666;
            display:flex;
            gap:20px;
            flex-wrap:wrap;
        ">
            <span>üìö {{ course.sections.count }} Sections</span>
            <span>‚è± Self-paced</span>
            <span>üèÜ Certificate</span>
        </div>
    </section>

    <!-- CURRICULUM -->
    <section>
        <h2 style="color:#7b2c2c; margin-bottom:25px;">
            Course Curriculum
        </h2>

        {% for section in course.sections.all %}
        <div style="
            background:#fff;
            padding:26px;
            border-radius:16px;
            margin-bottom:18px;
            box-shadow:0 6px 18px rgba(0,0,0,0.05);
        ">
            <h3 style="margin-top:0;">{{ section.title }}</h3>

            <ul style="padding-left:18px;">
                {% for lesson in section.lessons.all %}
                    {% if not enrolled %}
                        <li style="color:#999;">üîí {{ lesson.title }}</li>

                    {% elif lesson.id in completed_lessons %}
                        <li>
                            <a href="/courses/lesson/{{ lesson.id }}/"
                               style="color:#1e7e34;text-decoration:none;">
                                ‚úî {{ lesson.title }}
                            </a>
                        </li>

                    {% elif next_lesson and lesson.id == next_lesson.id %}
                        <li>
                            <a href="/courses/lesson/{{ lesson.id }}/"
                               style="color:#7b2c2c;font-weight:600;text-decoration:none;">
                                ‚ñ∂ {{ lesson.title }}
                            </a>
                        </li>

                    {% else %}
                        <li style="color:#999;">
                            üîí {{ lesson.title }} (Complete previous lesson)
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% empty %}
            <p>No lessons added yet.</p>
        {% endfor %}
    </section>

</div>

<!-- ================= RIGHT SIDEBAR ================= -->
<aside>
<div style="
    background:#fff;
    padding:35px;
    border-radius:20px;
    box-shadow:0 14px 34px rgba(0,0,0,0.12);
    position:sticky;
    top:30px;
">

    <h2 style="color:#7b2c2c; margin-top:0;">
        {% if course.price == 0 %}Free{% else %}‚Çπ{{ course.price }}{% endif %}
    </h2>

    {% if user.is_authenticated %}
        {% if enrolled %}
    {% if next_lesson %}
        <a href="/courses/lesson/{{ next_lesson.id }}/"
           class="btn"
           style="width:100%; text-align:center;">
            ‚ñ∂ Continue Learning
        </a>
    {% else %}
        <div style="
            margin-top:10px;
            padding:12px;
            background:#f5f5f5;
            color:#777;
            border-radius:8px;
            text-align:center;
            font-size:14px;
        ">
            üìò Course content will be available soon
        </div>
    {% endif %}


            <p style="margin-top:18px; font-weight:600;">
                Progress: {{ progress_percent }}%
            </p>

            <div style="background:#eee;height:10px;border-radius:10px;">
                <div style="
                    width:{{ progress_percent }}%;
                    height:100%;
                    background:#7b2c2c;
                "></div>
            </div>

            {% if progress_percent == 100 %}
                <a href="/certificate/{{ course.id }}/"
                   class="btn"
                   style="width:100%;margin-top:18px;">
                    üéì View Certificate
                </a>
            {% endif %}

        {% else %}
            {% if course.price == 0 %}
                <a href="/courses/enroll/{{ course.id }}/"
                   class="btn" style="width:100%;">
                    Enroll Free
                </a>
            {% else %}
                <a href="/payments/demo-pay/{{ course.id }}/"
                   class="btn" style="width:100%;">
                    Enroll Course
                </a>
            {% endif %}
        {% endif %}
    {% else %}
        <a href="/login/" class="btn" style="width:100%;">
            Login to Enroll
        </a>
    {% endif %}

    <hr style="margin:30px 0;">

    <ul style="padding-left:18px;color:#555;">
        <li>‚úî Lifetime access</li>
        <li>‚úî Structured lessons</li>
        <li>‚úî Progress tracking</li>
        <li>‚úî Completion certificate</li>
    </ul>

</div>
</aside>
</section>

<!-- ================= REVIEWS ================= -->
<section style="margin-top:60px;">

<h2 style="color:#7b2c2c;margin-bottom:20px;">Student Reviews</h2>

{% if reviews %}
    {% for review in reviews %}
    <div style="
        background:#fff;
        padding:22px;
        border-radius:16px;
        box-shadow:0 6px 18px rgba(0,0,0,0.05);
        margin-bottom:16px;
    ">
        <strong>{{ review.user.username }}</strong>
        <span style="color:#f4b400;margin-left:10px;">
            {% for i in "12345"|slice:":review.rating" %}‚òÖ{% endfor %}
        </span>

        <p style="margin-top:10px;color:#555;">
            {{ review.comment }}
        </p>

        <small style="color:#777;">
            {{ review.created_at|date:"M d, Y" }}
        </small>
    </div>
    {% endfor %}
{% else %}
    <p style="color:#777;">No reviews yet.</p>
{% endif %}

</section>

{% if enrolled and progress_percent == 100 and not has_reviewed %}
<section style="
    margin-top:40px;
    background:#fff;
    padding:30px;
    border-radius:18px;
    box-shadow:0 8px 22px rgba(0,0,0,0.06);
">
<h3 style="color:#7b2c2c;">Leave a Review</h3>

<form method="post" action="/courses/review/{{ course.id }}/">
    {% csrf_token %}
    <select name="rating" required style="padding:8px;">
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="3">‚≠ê‚≠ê‚≠ê</option>
        <option value="2">‚≠ê‚≠ê</option>
        <option value="1">‚≠ê</option>
    </select>

    <textarea name="comment"
              required
              rows="4"
              style="width:100%;margin-top:12px;padding:10px;"></textarea>

    <button class="btn" style="margin-top:15px;">
        Submit Review
    </button>
</form>
</section>

{% elif enrolled and progress_percent < 100 %}
<p style="margin-top:30px;color:#777;">
    ‚≠ê Complete all lessons to unlock reviews and certificate.
</p>
{% endif %}

{% endblock %}
